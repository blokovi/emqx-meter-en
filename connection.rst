
.. _connection_benchmark:

==========================
Concurrent connection test
==========================

The test scenario test the MQTT connection between client and server side, the clients don't send out any data except MQTT control and ping packet. The purpose of test is to get EMQ performance data under different connection numbers.

--------------
TCP Connection
--------------

Overall: The response time is less than 15ms within 1 million connection, successful rate is 100%. Memory usage is in line with increasing of connections. CPU usage is stable, but observed surge of CPU usage when connections are disconnectd.

.. NOTE:: Test agent configuration：1 VM runs 50000 VU (2 dockers*25000 VU)

300k conn
---------

+---------------------+-----------------+---------------------+--------------------+-----------------------+-------------------+-------------------+-----------------+
| Virtual user number | Conn per second | Test duration (Sec) | Average throughput | Average response time | Max response time | Min response time | Sussessful rate |
+=====================+=================+=====================+====================+=======================+===================+===================+=================+
|    300000           |        1000     |         600         |     912            |     9ms               |     7.02s         |    1ms            | 100%            | 
+---------------------+-----------------+---------------------+--------------------+-----------------------+-------------------+-------------------+-----------------+

+-------------------------------+-----------------------+-------------------------------------------------+
|     负载(Load)                |      CPU              |                   Memory                        |
+===============================+=======================+=================================================+
| CPU shortterm Load最大达到2.3 | CPU使用率在4%-31%之间 |  Memory使用随着并发用户量增加而增大，最大到4.2G |
+-------------------------------+-----------------------+-------------------------------------------------+

30万用户并发测试报告: https://www.xmeter.net/commercialPage.html#/testrunMonitor/895167331

50万线
------

+------------------+-----------------------+-------------------+------------+--------------+--------------+--------------+--------+
| 虚拟用户数量(VU) | 每秒新增并发链接(CPS) | 总计运行时间(Sec) | 平均吞吐量 | 平均响应时间 | 最大响应时间 | 最小响应时间 | 成功率 |
+==================+=======================+===================+============+==============+==============+==============+========+
|      500000      |          1000         |         900       |      966   |       14ms   |     7.04s    |     1ms      | 100%   |
+------------------+-----------------------+-------------------+------------+--------------+--------------+--------------+--------+

+--------------------------------+-----------------------+-------------------------------------------------+
|     负载(Load)                 |      CPU              |                   Memory                        |
+================================+=======================+=================================================+
| CPU shortterm Load最大达到3.88 | CPU使用率在7%-65%之间 |  Memory使用随着并发用户量增加而增大，最大到7.05G|
+--------------------------------+-----------------------+-------------------------------------------------+

50万用户并发测试报告: https://www.xmeter.net/commercialPage.html#/testrunMonitor/1231188268

100万线
-------

+------------------+-----------------------+-------------------+------------+--------------+--------------+--------------+--------+
| 虚拟用户数量(VU) | 每秒新增并发链接(CPS) | 总计运行时间(Sec) | 平均吞吐量 | 平均响应时间 | 最大响应时间 | 最小响应时间 | 成功率 |
+==================+=======================+===================+============+==============+==============+==============+========+
|      1000000     |        1000           |        1200       |    961     |      7ms     |     10.01s   |     1ms      | 100%   |
+------------------+-----------------------+-------------------+------------+--------------+--------------+--------------+--------+

+--------------------------------+-----------------------+-----------------------------------------------------+
|     负载(Load)                 |      CPU              |                   Memory                            |
+================================+=======================+=====================================================+
| CPU shortterm Load最大达到6    | CPU使用率在6%-80%之间 | Memory使用随着并发用户量增加而缓慢增加，最大到13.4G |
+--------------------------------+-----------------------+-----------------------------------------------------+

100万用户并发测试报告: https://www.xmeter.net/commercialPage.html#/testrunMonitor/2084906193

-----------
SSL单向认证
-----------

总体结果：EMQ在20万连接之内单向认证的连接，并且设置不重新连接的情况下，响应时间在50ms以内，成功率为100%，CPU和内存使用基本正常。如果在使用fusesource缺省的重新连接的情况下，会产生大量的重新连接请求，在测试30万连接的时候，发现多出了50%的conn连接请求，而connack却大幅小于30万，这可能是EMQ服务器端检测到有第二次重连的时候就会自动断开连接导致的，此配置下，在25万连接的时候24GB内存耗尽。

.. NOTE:: 测试机配置：1台虚拟机支持30000 VU (2个docker*15000 VU)

10万线
------

+------------------+-----------------------+-------------------+------------+--------------+--------------+--------------+--------+
| 虚拟用户数量(VU) | 每秒新增并发链接(CPS) | 总计运行时间(Sec) | 平均吞吐量 | 平均响应时间 | 最大响应时间 | 最小响应时间 | 成功率 |
+==================+=======================+===================+============+==============+==============+==============+========+
|       100000     |          500          |        400        |     467    |      41ms    |     7.58s    |     6ms      | 100%   |
+------------------+-----------------------+-------------------+------------+--------------+--------------+--------------+--------+

+--------------------------------+-----------------------+-----------------------------+------------------------------------------+
|     负载(Load)                 |      CPU              |           Memory            |                备注                      |
+================================+=======================+=============================+==========================================+
| CPU shortterm Load最大达到5    | CPU使用率不高于60%    | Memory使用随着并发用户量    | setConnectAttemptsMax=0                  |
|                                |                       | 增加而缓慢增加最大到11.88G  | setReconnectAttemptsMax=0                |
+--------------------------------+-----------------------+-----------------------------+------------------------------------------+

20万线
------

+------------------+-----------------------+-------------------+------------+--------------+--------------+--------------+--------+
| 虚拟用户数量(VU) | 每秒新增并发链接(CPS) | 总计运行时间(Sec) | 平均吞吐量 | 平均响应时间 | 最大响应时间 | 最小响应时间 | 成功率 |
+==================+=======================+===================+============+==============+==============+==============+========+
|      200000      |          500          |        1000       |     463    |      49ms    |    7.04s     |     6ms      | 100%   |
+------------------+-----------------------+-------------------+------------+--------------+--------------+--------------+--------+

+--------------------------------+-----------------------+-----------------------------+------------------------------------------+
|     负载(Load)                 |      CPU              |           Memory            |                备注                      |
+================================+=======================+=============================+==========================================+
| CPU shortterm Load最大达到6    | CPU使用率不高于73%    | Memory使用随着并发用户量    | setConnectAttemptsMax=0                  |
|                                |                       | 增加而缓慢增加最大到20.46G  | setReconnectAttemptsMax=0                |
+--------------------------------+-----------------------+-----------------------------+------------------------------------------+

-----------
SSL双向认证
-----------

总体结果：双向认证的时候设置成连接断开后不重新连接(setConnectAttemptsMax和setReconnectAttemptsMax都设置成为0)，响应时间增长到秒级，成功率在20万连接的情况降至86%，内存也基本耗尽。同样在10万连接的情况下，双向认证比单向认证多出了约3GB的内存使用。

.. NOTE:: 测试机配置：1台虚拟机支持30000 VU (2个docker*15000 VU)

10万线
------

+------------------+-----------------------+-------------------+------------+--------------+--------------+--------------+--------+
| 虚拟用户数量(VU) | 每秒新增并发链接(CPS) | 总计运行时间(Sec) | 平均吞吐量 | 平均响应时间 | 最大响应时间 | 最小响应时间 | 成功率 |
+==================+=======================+===================+============+==============+==============+==============+========+
|      100000      |           500         |       420         |     454    |      1s      |     10.06s   |    22ms      | 99.4%  |
+------------------+-----------------------+-------------------+------------+--------------+--------------+--------------+--------+

+--------------------------------+-----------------------+-----------------------------+------------------------------------------+
|     负载(Load)                 |      CPU              |           Memory            |                备注                      |
+================================+=======================+=============================+==========================================+
| CPU shortterm Load最大达到5    | CPU使用率不高于66%    | Memory使用随着并发用户量    | setConnectAttemptsMax=0                  |
|                                |                       | 增加而缓慢增加最大到14.92G  | setReconnectAttemptsMax=0                |
+--------------------------------+-----------------------+-----------------------------+------------------------------------------+

20万线
------

+------------------+-----------------------+-------------------+------------+--------------+--------------+--------------+--------+
| 虚拟用户数量(VU) | 每秒新增并发链接(CPS) | 总计运行时间(Sec) | 平均吞吐量 | 平均响应时间 | 最大响应时间 | 最小响应时间 | 成功率 |
+==================+=======================+===================+============+==============+==============+==============+========+
|      200000      |          500          |          600      |     473    |        3s    |     11.95s   |    22ms      | 86%    |
+------------------+-----------------------+-------------------+------------+--------------+--------------+--------------+--------+

+--------------------------------+-----------------------+-----------------------------+------------------------------------------+
|     负载(Load)                 |      CPU              |           Memory            |                备注                      |
+================================+=======================+=============================+==========================================+
| CPU shortterm Load最大达到6    | CPU使用率不高于77%    | Memory使用随着并发用户量    | setConnectAttemptsMax=0                  |
|                                |                       | 增加而缓慢增加最大到23.82G  | setReconnectAttemptsMax=0                |
+--------------------------------+-----------------------+-----------------------------+------------------------------------------+

