
.. _connection_benchmark:

============
并发连接测试
============

该测试场景只测试客户端到服务器端的MQTT协议连接，该测试场景下除了发送MQTT协议的控制包和PING包外，不发送任何用户数据相关的包，测试目的是为了得到EMQ消息服务器在不同并发连接下的表现。

-------
TCP连接
-------

总体结果：EMQ2.0在建立100万以内TCP连接的时候，响应时间都在15ms以内，成功率为100%。内存的使用基本呈线性增长，CPU在用户连接建立的时候表现平稳，没有大幅度的抖动。但是观察到在连接断开的场景下，会发生CPU使用率突然增加到100%的情况。

.. NOTE:: 测试机配置：1台虚拟机支持50000 VU (2个docker*25000 VU)

30万线
------

+------------------+-----------------------+-------------------+------------+--------------+--------------+--------------+--------+
| 虚拟用户数量(VU) | 每秒新增并发链接(CPS) | 总计运行时间(Sec) | 平均吞吐量 | 平均响应时间 | 最大响应时间 | 最小响应时间 | 成功率 |
+==================+=======================+===================+============+==============+==============+==============+========+
|    300000        |        1000           |         600       |     912    |     9ms      |     7.02s    |    1ms       | 100%   | 
+------------------+-----------------------+-------------------+------------+--------------+--------------+--------------+--------+

+-------------------------------+-----------------------+-------------------------------------------------+
|     负载(Load)                |      CPU              |                   Memory                        |
+===============================+=======================+=================================================+
| CPU shortterm Load最大达到2.3 | CPU使用率在4%-31%之间 |  Memory使用随着并发用户量增加而增大，最大到4.2G |
+-------------------------------+-----------------------+-------------------------------------------------+

30万用户并发测试报告: https://www.xmeter.net/commercialPage.html#/testrunMonitor/895167331

50万线
------

+------------------+-----------------------+-------------------+------------+--------------+--------------+--------------+--------+
| 虚拟用户数量(VU) | 每秒新增并发链接(CPS) | 总计运行时间(Sec) | 平均吞吐量 | 平均响应时间 | 最大响应时间 | 最小响应时间 | 成功率 |
+==================+=======================+===================+============+==============+==============+==============+========+
|      500000      |          1000         |         900       |      966   |       14ms   |     7.04s    |     1ms      | 100%   |
+------------------+-----------------------+-------------------+------------+--------------+--------------+--------------+--------+

+--------------------------------+-----------------------+-------------------------------------------------+
|     负载(Load)                 |      CPU              |                   Memory                        |
+================================+=======================+=================================================+
| CPU shortterm Load最大达到3.88 | CPU使用率在7%-65%之间 |  Memory使用随着并发用户量增加而增大，最大到7.05G|
+--------------------------------+-----------------------+-------------------------------------------------+

50万用户并发测试报告: https://www.xmeter.net/commercialPage.html#/testrunMonitor/1231188268

100万线
-------

+------------------+-----------------------+-------------------+------------+--------------+--------------+--------------+--------+
| 虚拟用户数量(VU) | 每秒新增并发链接(CPS) | 总计运行时间(Sec) | 平均吞吐量 | 平均响应时间 | 最大响应时间 | 最小响应时间 | 成功率 |
+==================+=======================+===================+============+==============+==============+==============+========+
|      1000000     |        1000           |        1200       |    961     |      7ms     |     10.01s   |     1ms      | 100%   |
+------------------+-----------------------+-------------------+------------+--------------+--------------+--------------+--------+

+--------------------------------+-----------------------+-----------------------------------------------------+
|     负载(Load)                 |      CPU              |                   Memory                            |
+================================+=======================+=====================================================+
| CPU shortterm Load最大达到6    | CPU使用率在6%-80%之间 | Memory使用随着并发用户量增加而缓慢增加，最大到13.4G |
+--------------------------------+-----------------------+-----------------------------------------------------+

100万用户并发测试报告: https://www.xmeter.net/commercialPage.html#/testrunMonitor/2084906193

-----------
SSL单向认证
-----------

总体结果：EMQ在20万连接之内单向认证的连接，并且设置不重新连接的情况下，响应时间在50ms以内，成功率为100%，CPU和内存使用基本正常。如果在使用fusesource缺省的重新连接的情况下，会产生大量的重新连接请求，在测试30万连接的时候，发现多出了50%的conn连接请求，而connack却大幅小于30万，这可能是EMQ服务器端检测到有第二次重连的时候就会自动断开连接导致的，此配置下，在25万连接的时候24GB内存耗尽。

.. NOTE:: 测试机配置：1台虚拟机支持30000 VU (2个docker*15000 VU)

10万线
------

+------------------+-----------------------+-------------------+------------+--------------+--------------+--------------+--------+
| 虚拟用户数量(VU) | 每秒新增并发链接(CPS) | 总计运行时间(Sec) | 平均吞吐量 | 平均响应时间 | 最大响应时间 | 最小响应时间 | 成功率 |
+==================+=======================+===================+============+==============+==============+==============+========+
|       100000     |          500          |        400        |     467    |      41ms    |     7.58s    |     6ms      | 100%   |
+------------------+-----------------------+-------------------+------------+--------------+--------------+--------------+--------+

+--------------------------------+-----------------------+-----------------------------+------------------------------------------+
|     负载(Load)                 |      CPU              |           Memory            |                备注                      |
+================================+=======================+=============================+==========================================+
| CPU shortterm Load最大达到5    | CPU使用率不高于60%    | Memory使用随着并发用户量    | setConnectAttemptsMax=0                  |
|                                |                       | 增加而缓慢增加最大到11.88G  | setReconnectAttemptsMax=0                |
+--------------------------------+-----------------------+-----------------------------+------------------------------------------+

20万线
------

+------------------+-----------------------+-------------------+------------+--------------+--------------+--------------+--------+
| 虚拟用户数量(VU) | 每秒新增并发链接(CPS) | 总计运行时间(Sec) | 平均吞吐量 | 平均响应时间 | 最大响应时间 | 最小响应时间 | 成功率 |
+==================+=======================+===================+============+==============+==============+==============+========+
|      200000      |          500          |        1000       |     463    |      49ms    |    7.04s     |     6ms      | 100%   |
+------------------+-----------------------+-------------------+------------+--------------+--------------+--------------+--------+

+--------------------------------+-----------------------+-----------------------------+------------------------------------------+
|     负载(Load)                 |      CPU              |           Memory            |                备注                      |
+================================+=======================+=============================+==========================================+
| CPU shortterm Load最大达到6    | CPU使用率不高于73%    | Memory使用随着并发用户量    | setConnectAttemptsMax=0                  |
|                                |                       | 增加而缓慢增加最大到20.46G  | setReconnectAttemptsMax=0                |
+--------------------------------+-----------------------+-----------------------------+------------------------------------------+

-----------
SSL双向认证
-----------

总体结果：双向认证的时候设置成连接断开后不重新连接(setConnectAttemptsMax和setReconnectAttemptsMax都设置成为0)，响应时间增长到秒级，成功率在20万连接的情况降至86%，内存也基本耗尽。同样在10万连接的情况下，双向认证比单向认证多出了约3GB的内存使用。

.. NOTE:: 测试机配置：1台虚拟机支持30000 VU (2个docker*15000 VU)

10万线
------

+------------------+-----------------------+-------------------+------------+--------------+--------------+--------------+--------+
| 虚拟用户数量(VU) | 每秒新增并发链接(CPS) | 总计运行时间(Sec) | 平均吞吐量 | 平均响应时间 | 最大响应时间 | 最小响应时间 | 成功率 |
+==================+=======================+===================+============+==============+==============+==============+========+
|      100000      |           500         |       420         |     454    |      1s      |     10.06s   |    22ms      | 99.4%  |
+------------------+-----------------------+-------------------+------------+--------------+--------------+--------------+--------+

+--------------------------------+-----------------------+-----------------------------+------------------------------------------+
|     负载(Load)                 |      CPU              |           Memory            |                备注                      |
+================================+=======================+=============================+==========================================+
| CPU shortterm Load最大达到5    | CPU使用率不高于66%    | Memory使用随着并发用户量    | setConnectAttemptsMax=0                  |
|                                |                       | 增加而缓慢增加最大到14.92G  | setReconnectAttemptsMax=0                |
+--------------------------------+-----------------------+-----------------------------+------------------------------------------+

20万线
------

+------------------+-----------------------+-------------------+------------+--------------+--------------+--------------+--------+
| 虚拟用户数量(VU) | 每秒新增并发链接(CPS) | 总计运行时间(Sec) | 平均吞吐量 | 平均响应时间 | 最大响应时间 | 最小响应时间 | 成功率 |
+==================+=======================+===================+============+==============+==============+==============+========+
|      200000      |          500          |          600      |     473    |        3s    |     11.95s   |    22ms      | 86%    |
+------------------+-----------------------+-------------------+------------+--------------+--------------+--------------+--------+

+--------------------------------+-----------------------+-----------------------------+------------------------------------------+
|     负载(Load)                 |      CPU              |           Memory            |                备注                      |
+================================+=======================+=============================+==========================================+
| CPU shortterm Load最大达到6    | CPU使用率不高于77%    | Memory使用随着并发用户量    | setConnectAttemptsMax=0                  |
|                                |                       | 增加而缓慢增加最大到23.82G  | setReconnectAttemptsMax=0                |
+--------------------------------+-----------------------+-----------------------------+------------------------------------------+

